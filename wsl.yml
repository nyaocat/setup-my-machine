---
- name: set up my machine
  hosts: localhost
  connection: local
  vars:
    docker_cli_plugins_dir: "{{ ansible_env.HOME }}/.docker/cli-plugins"
    docker_pussh_path: "{{ docker_cli_plugins_dir }}/docker-pussh"
    docker_pussh_url: "https://raw.githubusercontent.com/psviderski/unregistry/v0.3.0/docker-pussh"
  tasks:
    - name: setup packages
      become: yes
      block:
        - name: remove unneccesary packages
          ansible.builtin.apt:
            state: absent
            purge: yes
            name:
              - nano
              - vim-tiny
              - snapd
              - mise
        
        - name: install packages for gpg
          ansible.builtin.apt:
            state: present
            name:
              - apt-transport-https
              - ca-certificates
              - curl
              - software-properties-common
              - wget
              - gpg
              - sudo
        
        - name: Ensure Docker CLI plugins directory exists
          file:
            path: "{{ docker_cli_plugins_dir }}"
            state: directory
            mode: '0755'

        - name: Download docker-pussh plugin
          get_url:
            url: "{{ docker_pussh_url }}"
            dest: "{{ docker_pussh_path }}"
            mode: '0755'
    
        - name: install packages
          ansible.builtin.apt:
            autoremove: yes
            update_cache: yes
            state: latest
            name:
              - ansible
              - aria2
              - autoconf
              - bison
              - build-essential
              - curl
              - eza
              - ffmpeg
              - git
              - git-lfs
              - jq
              - make
              - openjdk-21-jdk-headless
              - patch
              - peco
              - pv
              - sqlite3
              - tar
              - tig
              - tmux
              - vim
              - zsh
          
        - name: set user shell to zsh
          ansible.builtin.user:
            name: "{{ ansible_user | default(ansible_env.USER) }}"
            shell: /usr/bin/zsh

    - name: check brew existence
      stat:
        path: /home/linuxbrew/.linuxbrew/bin/brew
      register: rc_brew
    
    - name: install linuxbrew
      when: not rc_brew.stat.exists
      block:
        - name: prepare hombrew directory
          become: yes
          ansible.builtin.file:
            path: /home/linuxbrew/.linuxbrew
            state: directory
            owner: "{{ ansible_user | default(ansible_env.USER) }}"
            group: "{{ ansible_user | default(ansible_env.USER) }}"
            mode: '0755'

        - name: install linuxbrew
          ansible.builtin.shell: |
            curl -fsSL https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C /home/linuxbrew/.linuxbrew

    - name: prepare ~/.config/git
      ansible.builtin.file:
        path: ~/.config/git
        state: directory

    - name: copy files
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      loop:
        - src: assets/ubuntu/zshrc
          dest: ~/.zshrc
        - src: assets/ubuntu/zprofile
          dest: ~/.zprofile
        - src: assets/tmux.conf
          dest: ~/.tmux.conf
        - src: assets/gitignore
          dest: ~/.config/git/ignore


